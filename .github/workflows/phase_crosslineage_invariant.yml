name: Crosslineage map invariant

on:
  pull_request:
  push:

jobs:
  crosslineage-guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce crosslineage map invariant
        shell: bash
        run: |
          base_ref="${GITHUB_BASE_REF:-}"
          if [ -n "${base_ref}" ]; then
            git fetch origin "${base_ref}"
            diff_scope="origin/${base_ref}...HEAD"
          else
            git fetch origin main
            diff_scope="origin/main...HEAD"
          fi
          map_path="scripts/2026-01-31/agents/notes/phase_crosslineage_map.yaml"
          override_path=".github/override/phase_crosslineage_map_edit.override"
          override_token="ALLOW_MAP_EDIT_OVERRIDE"
          if git diff --name-only "${diff_scope}" | rg -q "^${map_path}$"; then
            if ! git diff --name-only "${diff_scope}" | rg -q "^${override_path}$"; then
              echo "FAIL: ${map_path} changed in ${diff_scope} without override ${override_path}"
              exit 1
            fi
            if ! rg -x "${override_token}" "${override_path}"; then
              echo "FAIL: ${override_path} must contain only ${override_token}"
              exit 1
            fi
            echo "ALLOW: override file present"
          else
            echo "PASS: ${map_path} unchanged in ${diff_scope}"
          fi

      - name: Lint abstract against map
        shell: bash
        run: |
          map_path="scripts/2026-01-31/agents/notes/phase_crosslineage_map.yaml"
          abstract_root="scripts/2026-01-31/agents/work-tree"
          python3 scripts/2026-01-31/agents/tools/lint_abstract_against_map.py "$map_path" "$abstract_root"
